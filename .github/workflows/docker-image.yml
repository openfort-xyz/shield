name: Publish Docker image

on:
  release:
    types: [published]

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read
      attestations: write
      packages: write

    steps:
      - name: Check out code
        uses: actions/checkout@v5

      - name: Set up SSH key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          name: id_rsa
          known_hosts: ${{ secrets.SSH_HOST }}

      - name: Set up Git
        run: git config --global url.ssh://git@github.com/.insteadOf https://github.com/

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          context: .
          file: Dockerfile
          push: true
          sbom: true
          provenance: mode=max
          tags: |
            ghcr.io/${{ github.repository }}:${{ github.event.release.tag_name }}
            ghcr.io/${{ github.repository }}:latest

      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a
        with:
          subject-name: ghcr.io/${{ github.repository }}
          subject-digest: ${{ steps.build.outputs.digest }}
          push-to-registry: true

      - name: Set up yq
        uses: chrisdickinson/setup-yq@latest
        with:
          version: 4.30.8

      - name: Clone Infra Repository
        run: |
          git clone git@github.com:openfort-xyz/kube.git

      - name: Update version
        uses: mikefarah/yq@master
        with:
          cmd: yq -i '.shield.tag = "${{ github.event.release.tag_name }}"' kube/values.yaml

      - name: Update Infra Repository
        run: |
          cd kube
          git config --global user.email "cd@openfort.xyz"
          git config --global user.name "CD"
          git add .
          git commit -m "Update Shield version to ${{ github.event.release.tag_name }}"
          git push
